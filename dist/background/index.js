(()=>{"use strict";const e=new class{constructor(){this.CACHE_TTL=864e5,this.CACHE_MAX_AGE=6048e5,this.DAILY_FREE_LIMIT=50}async cacheResult(e,t){const a=`cache_${e}`;await chrome.storage.local.set({[a]:{...t,cachedAt:Date.now()}})}async getCachedResult(e){const t=`cache_${e}`,a=(await chrome.storage.local.get(t))[t];return a?Date.now()-a.cachedAt>this.CACHE_TTL?(await chrome.storage.local.remove(t),null):a:null}async getSettings(){return{enabled:!0,platforms:{amazon:!0,reddit:!0,googlemaps:!0,universal:!1},sensitivity:"balanced",showBadges:!0,showTooltips:!0,deepScanEnabled:!1,apiKey:null,tier:"free",...(await chrome.storage.local.get("settings")).settings||{}}}async updateSettings(e){const t={...await this.getSettings(),...e};return await chrome.storage.local.set({settings:t}),t}async getUsageToday(){const e=(new Date).toISOString().split("T")[0],t=(await chrome.storage.local.get("usage")).usage||{};return t.date!==e?{date:e,scans:0,deepScans:0}:t}async incrementUsage(e="scans"){const t=await this.getUsageToday();return t[e]=(t[e]||0)+1,await chrome.storage.local.set({usage:t}),t}async canScan(){return"free"!==(await this.getSettings()).tier||(await this.getUsageToday()).scans<this.DAILY_FREE_LIMIT}async recordScan(e){const t=(await chrome.storage.local.get("stats")).stats||{totalScans:0,flaggedContent:0,platformBreakdown:{},firstScan:Date.now()};t.totalScans++,"LOW_TRUST"!==e.level&&"VERY_LOW_TRUST"!==e.level||t.flaggedContent++;const a=e.platform||"unknown";return t.platformBreakdown[a]=(t.platformBreakdown[a]||0)+1,t.lastScan=Date.now(),await chrome.storage.local.set({stats:t}),t}async getStats(){return(await chrome.storage.local.get("stats")).stats||{totalScans:0,flaggedContent:0,platformBreakdown:{}}}async cleanupOldCache(){const e=await chrome.storage.local.get(null),t=[];for(const[a,n]of Object.entries(e))a.startsWith("cache_")&&n.cachedAt&&Date.now()-n.cachedAt>this.CACHE_MAX_AGE&&t.push(a);return t.length>0&&await chrome.storage.local.remove(t),t.length}},t={HIGH_TRUST:"#22c55e",MODERATE_TRUST:"#eab308",LOW_TRUST:"#f97316",VERY_LOW_TRUST:"#ef4444",INSUFFICIENT_DATA:"#6b7280",INACTIVE:"#333333"};chrome.runtime.onMessage.addListener((a,n,s)=>{switch(a.type){case"PAGE_SCORED":!function(a,n){if(!n?.id)return;const{score:s}=a,o=t[s.level]||t.INACTIVE,c=null!==s.score?Math.round(100*s.score).toString():"?";chrome.action.setBadgeBackgroundColor({color:o,tabId:n.id}),chrome.action.setBadgeText({text:c,tabId:n.id});chrome.action.setTitle({title:`Dead Internet Detector: ${{HIGH_TRUST:"Likely Authentic",MODERATE_TRUST:"Mixed Signals",LOW_TRUST:"Questionable",VERY_LOW_TRUST:"Likely Inauthentic",INSUFFICIENT_DATA:"Insufficient Data"}[s.level]||"Unknown"}`,tabId:n.id}),e.recordScan(s),e.incrementUsage("scans")}(a.data,n.tab);break;case"GET_SETTINGS":return e.getSettings().then(s),!0;case"UPDATE_SETTINGS":return e.updateSettings(a.data).then(s),!0;case"GET_STATS":return e.getStats().then(s),!0;case"GET_USAGE":return e.getUsageToday().then(s),!0;case"CAN_SCAN":return e.canScan().then(s),!0;case"GET_CACHED":return e.getCachedResult(a.key).then(s),!0}}),chrome.alarms.create("dailyCleanup",{periodInMinutes:1440}),chrome.alarms.onAlarm.addListener(async t=>{if("dailyCleanup"===t.name){const t=await e.cleanupOldCache();console.log(`[DID] Cache cleanup: removed ${t} old entries`)}}),chrome.runtime.onInstalled.addListener(async t=>{"install"===t.reason&&(await e.updateSettings({enabled:!0,sensitivity:"balanced"}),console.log("[DID] Dead Internet Detector installed")),"update"===t.reason&&console.log(`[DID] Updated to v${chrome.runtime.getManifest().version}`)}),chrome.tabs.onUpdated.addListener((e,t)=>{"loading"===t.status&&chrome.action.setBadgeText({text:"",tabId:e})})})();