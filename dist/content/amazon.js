(()=>{"use strict";class e{constructor(){this.aiTellPhrases=["it's worth noting","it is worth noting","a testament to","game-changer","game changer","delve into","tapestry","multifaceted","in today's world","in the realm of","navigating the","stands out as","it should be noted","in this regard","underscores","fostering","holistic","elevate the","elevates the","truly remarkable","new heights","commitment to excellence","user experience","attention to detail is","works flawlessly","couldn't be happier","changed my daily routine","both elegant and practical"],this.hypeWords=["amazing","incredible","fantastic","exceptional","remarkable","outstanding","unbeatable","flawlessly","truly","absolutely","every way","everyone","definitely","certainly"],this.fakeReviewTemplates=["i bought this for my","i purchased this for","my husband/wife loves","exactly as described","exactly what i needed","highly recommend this product","five stars all the way","exceeded my expectations","i was skeptical at first but","worth every penny","great quality for the price","you won't be disappointed","must have product","i've tried many similar products","this is by far the best","don't hesitate to buy","arrived quickly and well packaged"]}analyze(e){if(!e||e.length<20)return{aiDetection:null,repetitionPattern:null,sentimentConsistency:null,vocabularyDistribution:null,templateMatching:null};const t=e.toLowerCase().trim();return{aiDetection:this._detectAIPatterns(t),repetitionPattern:this._analyzeRepetition(t),sentimentConsistency:this._analyzeSentiment(t),vocabularyDistribution:this._analyzeVocabulary(t),templateMatching:this._detectTemplates(t)}}_detectAIPatterns(e){let t=0;const s=[];for(const n of this.aiTellPhrases){const a=new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),i=e.match(a);i&&(t+=i.length,s.push(n))}const n=t/(e.length/500);let a=0;for(const t of this.hypeWords){const s=new RegExp("\\b"+t+"\\b","gi"),n=e.match(s);n&&(a+=n.length)}const i=a/(e.length/500);let r=1;return t>0&&(r-=Math.min(.5,.25*n)),i>3&&(r-=Math.min(.4,.1*(i-2))),r=Math.max(0,Math.min(1,r)),{score:r,detail:s.length>0||a>3?`Found ${t} AI-associated phrases, ${a} hype words`:null}}_analyzeRepetition(e){const t=e.split(/[.!?]+/).filter(e=>e.trim().length>10);if(t.length<2)return{score:.5,detail:null};const s=this._extractNgrams(e,3),n={};for(const e of s)n[e]=(n[e]||0)+1;const a=Object.values(n).filter(e=>e>2).length,i=a/Math.max(1,s.length),r=t.map(e=>e.trim().split(/\s+/).slice(0,3).join(" ")),o=new Set(r).size/r.length;let l=0;const c=t.reduce((e,t)=>e+t.trim().split(/\s+/).length,0)/t.length;t.reduce((e,t)=>{const s=t.trim().split(/\s+/).length;return e+Math.pow(s-c,2)},0)/t.length<8&&t.length>=3&&(l=.3);const u=["because","since","so","which","where","when","after","before","while","then"];let h=0;for(const t of e.split(/\s+/))u.includes(t.toLowerCase().replace(/[^a-z]/g,""))&&h++;0===h&&t.length>=4&&(l+=.2);let d=1;return d-=.3*(1-o),d-=Math.min(.3,50*i*.3),d-=l,{score:Math.max(0,Math.min(1,d)),detail:d<.5?`Formulaic structure detected: ${a} repeated phrases, low sentence variation`:null}}_analyzeSentiment(e){const t=["great","amazing","excellent","perfect","love","best","wonderful","fantastic","awesome","incredible","superb","outstanding","brilliant","magnificent","terrific","fabulous","happy","recommend"],s=["bad","terrible","awful","worst","hate","horrible","poor","disappointing","broken","waste","junk","useless","defective","cheap","flimsy","garbage"],n=["but","however","although","though","except","unless","somewhat","slightly","minor","small issue","only complaint","downside","only","wish","could be","not perfect"],a=[/\d+\s*(inch|mm|cm|lb|kg|oz|gb|mb|watt|hour|day|week|month|minute)/i,/\d+\/\d+/,/\$\d+/,/[A-Z][a-z]+ [A-Z]/,/my (wife|husband|son|daughter|mom|dad|friend|sister|brother|kid)/i],i=e.split(/\s+/),r=i.length;let o=0,l=0,c=0;for(const e of i){const a=e.replace(/[^a-z]/g,"");t.includes(a)&&o++,s.includes(a)&&l++,n.includes(a)&&c++}const u=o/r;let h=0;for(const t of a)t.test(e)&&h++;return u>.06&&0===c&&0===l&&0===h?{score:.15,detail:"Uniformly positive with no nuance or specific details"}:u>.08&&0===h?{score:.3,detail:"Very high praise density without concrete details"}:u>.06&&0===c&&0===l&&h>0?{score:.45,detail:"Positive without hedging but contains specific details"}:c>0||o>0&&l>0?{score:.85,detail:null}:{score:.6,detail:null}}_analyzeVocabulary(e){const t=e.split(/\s+/).map(e=>e.replace(/[^a-z]/g,"")).filter(e=>e.length>2);if(t.length<20)return{score:.5,detail:null};const s=new Set(t).size/t.length,n=new Set(["product","item","thing","purchase","quality","price","everything","everyone","anyone","nothing","something","ever","always","never","every","very","really","just","amazing","great","good","nice","best","love","happy"]);let a=0;for(const e of t)n.has(e)&&a++;const i=a/t.length;let r;r=s>.85&&t.length>100?.5:s<.3?.35:.7+.2*s,i>.2?r-=.35:i>.15&&(r-=.2);const o=t.reduce((e,t)=>e+t.length,0)/t.length;return t.reduce((e,t)=>e+Math.pow(t.length-o,2),0)/t.length<3&&(r*=.8),{score:Math.max(0,Math.min(1,r)),detail:r<.4?`Vocabulary lacks specificity (${Math.round(100*i)}% generic words)`:null}}_detectTemplates(e){let t=0;const s=[];for(const n of this.fakeReviewTemplates)e.includes(n)&&(t++,s.push(n));return{score:Math.max(0,1-.3*t),detail:t>0?`Matched ${t} common fake review template phrase${t>1?"s":""}`:null}}_extractNgrams(e,t){const s=e.split(/\s+/).filter(e=>e.length>0),n=[];for(let e=0;e<=s.length-t;e++)n.push(s.slice(e,e+t).join(" "));return n}}class t{constructor(){this.singleAnalyzer=new e}analyzeBatch(e){return{individual:e.map(e=>this.singleAnalyzer.analyze(e)),batch:this._analyzeCrossPatterns(e)}}_analyzeCrossPatterns(e){if(e.length<3)return{coordinatedLanguage:null,ratingDistribution:null,timingCluster:null};const t=this._findSharedPhrases(e);return{coordinatedLanguage:{score:Math.max(0,1-.15*t.length),detail:t.length>3?`Found ${t.length} phrases repeated across multiple reviews`:null,sharedPhrases:t}}}_findSharedPhrases(e){const t=e.map(e=>{const t=e.toLowerCase().split(/\s+/),s=new Set;for(let e=0;e<=t.length-4;e++)s.add(t.slice(e,e+4).join(" "));return s}),s={};for(const e of t)for(const t of e)s[t]=(s[t]||0)+1;return Object.entries(s).filter(([e,t])=>t>=3).map(([e,t])=>({phrase:e,count:t})).sort((e,t)=>t.count-e.count)}}class s{constructor(){this.suspiciousPatterns={burstThreshold:5,minAccountAgeDays:30,allSameRatingThreshold:.9,reviewsPerDayMax:3}}analyze(e){return{accountAge:this._scoreAccountAge(e),postingFrequency:this._scorePostingFrequency(e),reviewDiversity:this._scoreReviewDiversity(e),profileCompleteness:this._scoreProfileCompleteness(e),networkConnections:this._scoreNetworkSignals(e)}}analyzeBatch(e){return{individual:e.map(e=>this.analyze(e)),batch:{timingCluster:this._detectTimingClusters(e),accountAgeCluster:this._detectAccountAgeCluster(e)}}}_scoreAccountAge(e){if(!e.accountCreated&&!e.firstReviewDate)return null;const t=e.accountCreated||e.firstReviewDate,s=(Date.now()-new Date(t).getTime())/864e5;return s<7?{score:.1,detail:"Account created within the last week"}:s<30?{score:.3,detail:"Account less than 30 days old"}:s<90?{score:.6,detail:null}:{score:.9,detail:null}}_scorePostingFrequency(e){if(!e.reviewDates||e.reviewDates.length<2)return null;const t=e.reviewDates.map(e=>new Date(e)).sort((e,t)=>e-t),s={};for(const e of t){const t=e.toISOString().split("T")[0];s[t]=(s[t]||0)+1}const n=Math.max(...Object.values(s)),a=t.length/Object.keys(s).length;return n>this.suspiciousPatterns.burstThreshold?{score:.15,detail:`${n} reviews posted on a single day`}:a>this.suspiciousPatterns.reviewsPerDayMax?{score:.3,detail:"Unusually high review frequency"}:{score:.8,detail:null}}_scoreReviewDiversity(e){if(!e.ratings||e.ratings.length<3)return null;const t=e.ratings,s={};for(const e of t)s[e]=(s[e]||0)+1;const n=Math.max(...Object.values(s))/t.length;if(n>=this.suspiciousPatterns.allSameRatingThreshold){const e=Object.entries(s).sort(([,e],[,t])=>t-e)[0][0];return{score:.2,detail:`${Math.round(100*n)}% of reviews are ${e}-star`}}if(e.reviewCategories&&new Set(e.reviewCategories).size/e.reviewCategories.length<.1&&e.reviewCategories.length>10)return{score:.35,detail:"Reviews concentrated in a single product category"};const a=Object.keys(s).length,i=Math.min(1,a/5*.5+.5*(1-n));return{score:Math.max(.4,i),detail:null}}_scoreProfileCompleteness(e){let t=0;const s=["displayName","avatarUrl","bio","location","helpfulVotes","totalReviews"];for(const n of s)e[n]&&t++;const n=t/s.length;return n<.3?{score:.3,detail:"Minimal profile information"}:{score:Math.max(.5,n),detail:null}}_scoreNetworkSignals(e){if(void 0!==e.helpfulVotes&&e.totalReviews){const t=e.helpfulVotes/e.totalReviews;if(t<.1&&e.totalReviews>20)return{score:.4,detail:"Very low helpful vote ratio despite many reviews"};if(t>1)return{score:.9,detail:null}}return null}_detectTimingClusters(e){const t=[];for(const s of e)s.reviewDate&&t.push(new Date(s.reviewDate).getTime());if(t.length<5)return null;t.sort((e,t)=>e-t);const s=[];let n=[t[0]];for(let e=1;e<t.length;e++)t[e]-t[e-1]<864e5?n.push(t[e]):(n.length>=3&&s.push(n),n=[t[e]]);if(n.length>=3&&s.push(n),0===s.length)return{score:.8,detail:null};const a=Math.max(...s.map(e=>e.length)),i=a/t.length;return i>.5?{score:.15,detail:`${a} of ${t.length} reviews posted within 24 hours of each other`}:{score:Math.max(.3,1-i),detail:i>.3?"Review timing shows clustering patterns":null}}_detectAccountAgeCluster(e){const t=e.filter(e=>e.accountCreated).map(e=>new Date(e.accountCreated).getTime());return t.length<3?null:(t.sort((e,t)=>e-t),t[t.length-1]-t[0]<6048e5&&t.length>=5?{score:.1,detail:`${t.length} reviewer accounts created within the same week`}:{score:.7,detail:null})}}class n{constructor(e={}){this.displayName=e.displayName||null,this.avatarUrl=e.avatarUrl||null,this.bio=e.bio||null,this.location=e.location||null,this.accountCreated=e.accountCreated||null,this.firstReviewDate=e.firstReviewDate||null,this.totalReviews=e.totalReviews||null,this.helpfulVotes=e.helpfulVotes||null,this.ratings=e.ratings||[],this.reviewDates=e.reviewDates||[],this.reviewCategories=e.reviewCategories||[],this.reviewDate=e.reviewDate||null,this.verifiedPurchase=e.verifiedPurchase||!1}}class a{constructor(e={}){this.weights={text:{aiDetection:.25,repetitionPattern:.2,sentimentConsistency:.15,vocabularyDistribution:.15,templateMatching:.25},account:{accountAge:.3,postingFrequency:.25,reviewDiversity:.2,profileCompleteness:.15,networkConnections:.1},behavioral:{timingCluster:.35,coordinatedLanguage:.35,ratingDistribution:.3},media:{reverseImageMatch:.4,exifAnalysis:.25,aiArtifacts:.35}},this.categoryWeights={text:.3,account:.25,behavioral:.3,media:.15},this.thresholds={HIGH_TRUST:.75,MODERATE_TRUST:.5,LOW_TRUST:.3,VERY_LOW_TRUST:.15},this.config={minSignalsRequired:3,confidenceDecay:.85,...e}}computeScore(e){const t={},s=[];let n=0;for(const[a,i]of Object.entries(e)){if(!this.weights[a])continue;const e=this._scoreCatgory(a,i,this.weights[a]);e.signalCount>0&&(t[a]=e,n+=e.signalCount,s.push(...e.issues))}if(n<this.config.minSignalsRequired)return new i({score:null,level:"INSUFFICIENT_DATA",confidence:0,message:"Not enough data to assess authenticity",details:t,issues:[],signalCount:n});let a=0,r=0;for(const[e,s]of Object.entries(t)){const t=this.categoryWeights[e]||0;a+=s.score*t,r+=t}a=r>0?a/r:.5;const o=n/10,l=Math.min(1,o)*this.config.confidenceDecay,c=this._getTrustLevel(a),u=this._generateMessage(c,s,l);return new i({score:a,level:c,confidence:l,message:u,details:t,issues:s,signalCount:n})}_scoreCatgory(e,t,s){let n=0,a=0,i=0;const r=[];for(const[o,l]of Object.entries(t)){if(null==l)continue;const t=s[o]||0,c="object"==typeof l?l.score:l;null!=c&&(n+=c*t,a+=t,i++,c<.4&&r.push({category:e,signal:o,score:c,detail:"object"==typeof l?l.detail:null,severity:c<.2?"high":"medium"}))}return{score:a>0?n/a:.5,signalCount:i,issues:r}}_getTrustLevel(e){return e>=this.thresholds.HIGH_TRUST?"HIGH_TRUST":e>=this.thresholds.MODERATE_TRUST?"MODERATE_TRUST":e>=this.thresholds.LOW_TRUST?"LOW_TRUST":"VERY_LOW_TRUST"}_generateMessage(e,t,s){const n=s<.5?"Limited data suggests":"",a={HIGH_TRUST:"This content appears authentic based on available signals.",MODERATE_TRUST:`Mixed signals detected. ${t.length} potential concern${1!==t.length?"s":""} found.`,LOW_TRUST:`Multiple markers suggest this content may not be authentic. ${t.length} concern${1!==t.length?"s":""} flagged.`,VERY_LOW_TRUST:`Strong indicators of inauthentic content detected. ${t.length} significant concern${1!==t.length?"s":""} found.`}[e]||"Unable to assess.";return n?`${n}: ${a}`:a}}class i{constructor({score:e,level:t,confidence:s,message:n,details:a,issues:i,signalCount:r}){this.score=e,this.level=t,this.confidence=s,this.message=n,this.details=a,this.issues=i,this.signalCount=r,this.timestamp=Date.now(),Object.freeze(this)}get color(){return{HIGH_TRUST:"#22c55e",MODERATE_TRUST:"#eab308",LOW_TRUST:"#f97316",VERY_LOW_TRUST:"#ef4444",INSUFFICIENT_DATA:"#6b7280"}[this.level]||"#6b7280"}get icon(){return{HIGH_TRUST:"✓",MODERATE_TRUST:"⚠",LOW_TRUST:"⚠",VERY_LOW_TRUST:"✕",INSUFFICIENT_DATA:"?"}[this.level]||"?"}toJSON(){return{score:this.score,level:this.level,confidence:this.confidence,message:this.message,issues:this.issues,signalCount:this.signalCount,timestamp:this.timestamp}}}class r{constructor(){this.namespace="did",this.initialized=!1}renderProductBadge(e,t){const s=document.querySelector(`.${this.namespace}-product-badge`);s&&s.remove();const n=document.createElement("div");n.className=`${this.namespace}-product-badge`,n.setAttribute("data-trust-level",e.level),n.innerHTML=`\n      <div class="${this.namespace}-badge-compact">\n        <span class="${this.namespace}-badge-icon" style="color: ${e.color}">\n          ${e.icon}\n        </span>\n        <span class="${this.namespace}-badge-label">\n          Review Authenticity: <strong>${this._getLevelLabel(e.level)}</strong>\n        </span>\n        <span class="${this.namespace}-badge-score">\n          ${null!==e.score?Math.round(100*e.score)+"%":"—"}\n        </span>\n        <button class="${this.namespace}-badge-expand" aria-label="Show details">▾</button>\n      </div>\n      <div class="${this.namespace}-badge-details" style="display: none;">\n        <div class="${this.namespace}-badge-message">${e.message}</div>\n        ${this._renderIssuesList(e.issues)}\n        <div class="${this.namespace}-badge-meta">\n          Based on ${e.signalCount} analysis signals · \n          Confidence: ${Math.round(100*(e.confidence||0))}%\n        </div>\n        <div class="${this.namespace}-badge-disclaimer">\n          Dead Internet Detector provides indicators, not definitive judgments. \n          Use your own judgment alongside these signals.\n        </div>\n      </div>\n    `;const a=n.querySelector(`.${this.namespace}-badge-expand`),i=n.querySelector(`.${this.namespace}-badge-details`);a.addEventListener("click",()=>{const e="none"===i.style.display;i.style.display=e?"block":"none",a.textContent=e?"▴":"▾"});const r=document.querySelector("#cm-cr-dp-review-list")||document.querySelector("#reviews-medley-footer");r?r.parentNode.insertBefore(n,r):document.body.appendChild(n)}renderReviewBadge(e,t){if(!t)return;if(t.querySelector(`.${this.namespace}-review-badge`))return;const s=document.createElement("div");s.className=`${this.namespace}-review-badge`,s.setAttribute("data-trust-level",e.level);const n=null!==e.score?Math.round(100*e.score)+"%":"?";s.innerHTML=`\n      <span class="${this.namespace}-review-indicator" \n            style="background-color: ${e.color}"\n            title="${e.message}">\n        ${e.icon} ${n}\n      </span>\n    `;const a=document.createElement("div");a.className=`${this.namespace}-review-tooltip`,a.innerHTML=`\n      <div class="${this.namespace}-tooltip-title">\n        Authenticity Score: ${n}\n      </div>\n      <div class="${this.namespace}-tooltip-message">${e.message}</div>\n      ${e.issues.length>0?`\n        <ul class="${this.namespace}-tooltip-issues">\n          ${e.issues.slice(0,3).map(e=>`\n            <li class="${this.namespace}-tooltip-issue ${this.namespace}-severity-${e.severity}">\n              ${e.detail||this._formatSignalName(e.signal)}\n            </li>\n          `).join("")}\n        </ul>\n      `:""}\n    `,s.appendChild(a);const i=s.querySelector(`.${this.namespace}-review-indicator`);i.addEventListener("mouseenter",()=>{a.style.display="block"}),i.addEventListener("mouseleave",()=>{a.style.display="none"}),t.style.position="relative",t.insertBefore(s,t.firstChild)}_getLevelLabel(e){return{HIGH_TRUST:"Likely Authentic",MODERATE_TRUST:"Mixed Signals",LOW_TRUST:"Questionable",VERY_LOW_TRUST:"Likely Inauthentic",INSUFFICIENT_DATA:"Insufficient Data"}[e]||"Unknown"}_renderIssuesList(e){return e&&0!==e.length?`\n      <ul class="${this.namespace}-issues-list">\n        ${e.map(e=>`\n          <li class="${this.namespace}-issue ${this.namespace}-severity-${e.severity}">\n            <span class="${this.namespace}-issue-category">${this._formatCategory(e.category)}</span>\n            <span class="${this.namespace}-issue-detail">\n              ${e.detail||this._formatSignalName(e.signal)}\n            </span>\n          </li>\n        `).join("")}\n      </ul>\n    `:'<div class="did-no-issues">No specific concerns flagged.</div>'}_formatCategory(e){return{text:"Content",account:"Reviewer",behavioral:"Pattern",media:"Media"}[e]||e}_formatSignalName(e){return e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase()).trim()}}class o{constructor(){this.CACHE_TTL=864e5,this.CACHE_MAX_AGE=6048e5,this.DAILY_FREE_LIMIT=50}async cacheResult(e,t){const s=`cache_${e}`;await chrome.storage.local.set({[s]:{...t,cachedAt:Date.now()}})}async getCachedResult(e){const t=`cache_${e}`,s=(await chrome.storage.local.get(t))[t];return s?Date.now()-s.cachedAt>this.CACHE_TTL?(await chrome.storage.local.remove(t),null):s:null}async getSettings(){return{enabled:!0,platforms:{amazon:!0,reddit:!0,googlemaps:!0,universal:!1},sensitivity:"balanced",showBadges:!0,showTooltips:!0,deepScanEnabled:!1,apiKey:null,tier:"free",...(await chrome.storage.local.get("settings")).settings||{}}}async updateSettings(e){const t={...await this.getSettings(),...e};return await chrome.storage.local.set({settings:t}),t}async getUsageToday(){const e=(new Date).toISOString().split("T")[0],t=(await chrome.storage.local.get("usage")).usage||{};return t.date!==e?{date:e,scans:0,deepScans:0}:t}async incrementUsage(e="scans"){const t=await this.getUsageToday();return t[e]=(t[e]||0)+1,await chrome.storage.local.set({usage:t}),t}async canScan(){return"free"!==(await this.getSettings()).tier||(await this.getUsageToday()).scans<this.DAILY_FREE_LIMIT}async recordScan(e){const t=(await chrome.storage.local.get("stats")).stats||{totalScans:0,flaggedContent:0,platformBreakdown:{},firstScan:Date.now()};t.totalScans++,"LOW_TRUST"!==e.level&&"VERY_LOW_TRUST"!==e.level||t.flaggedContent++;const s=e.platform||"unknown";return t.platformBreakdown[s]=(t.platformBreakdown[s]||0)+1,t.lastScan=Date.now(),await chrome.storage.local.set({stats:t}),t}async getStats(){return(await chrome.storage.local.get("stats")).stats||{totalScans:0,flaggedContent:0,platformBreakdown:{}}}async cleanupOldCache(){const e=await chrome.storage.local.get(null),t=[];for(const[s,n]of Object.entries(e))s.startsWith("cache_")&&n.cachedAt&&Date.now()-n.cachedAt>this.CACHE_MAX_AGE&&t.push(s);return t.length>0&&await chrome.storage.local.remove(t),t.length}}const l="#cm-cr-dp-review-list, #cm_cr-review_list, .review-views .cr-widget-Reviews",c='[data-hook="review"]',u='[data-hook="review-body"] span',h='[data-hook="review-title"] span, [data-hook="review-title"]',d='[data-hook="review-star-rating"] span, [data-hook="cmps-review-star-rating"] span, [data-hook="review-star-rating"]',g='[data-hook="review-date"]',m=".a-profile-name",p='[data-hook="avp-badge"]',w='[data-hook="helpful-vote-statement"]';let y=null;chrome.runtime.onMessage.addListener((e,t,s)=>{"GET_PAGE_SCORE"===e.type&&s({score:y?.toJSON()||null,platform:"amazon"})});const f=new class{constructor(){this.textAnalyzer=new e,this.batchAnalyzer=new t,this.accountAnalyzer=new s,this.trustScorer=new a,this.renderer=new r,this.storage=new o,this.isRunning=!1}async init(){const e=document.querySelector(l),t=document.querySelectorAll(c).length>0;e||t?(await this.run(),this._observeForNewReviews()):this._observeForReviews()}async run(){if(!this.isRunning){this.isRunning=!0;try{const e=this._extractReviews();if(0===e.length)return void(this.isRunning=!1);const t=this._extractProductMeta(),s=e.map(e=>this.textAnalyzer.analyze(e.text)),n=this.batchAnalyzer.analyzeBatch(e.map(e=>e.text)),a=this.accountAnalyzer.analyzeBatch(e.map(e=>e.profile)),i=this._analyzeRatingDistribution(t),r=e.map((e,t)=>{const n={text:s[t],account:a.individual[t],behavioral:{timingCluster:a.batch.timingCluster,ratingDistribution:i}};return{review:e,result:this.trustScorer.computeScore(n),element:e.element}}),o={text:this._aggregateSignals(s),behavioral:{timingCluster:a.batch.timingCluster,coordinatedLanguage:n.batch.coordinatedLanguage,ratingDistribution:i},account:this._aggregateSignals(a.individual)},l=this.trustScorer.computeScore(o);this.renderer.renderProductBadge(l,t);for(const e of r)this.renderer.renderReviewBadge(e.result,e.element);t.asin&&await this.storage.cacheResult(t.asin,{overall:l.toJSON(),reviewCount:e.length,timestamp:Date.now()}),y=l,chrome.runtime.sendMessage({type:"PAGE_SCORED",data:{url:window.location.href,score:l.toJSON(),platform:"amazon"}})}catch(e){console.error("[DID] Amazon analysis error:",e)}finally{this.isRunning=!1}}}_extractReviews(){const e=document.querySelectorAll(c),t=[];for(const s of e)try{const e=s.querySelector(u),a=s.querySelector(h),i=s.querySelector(d),r=s.querySelector(g),o=s.querySelector(m),l=(s.querySelector(".a-profile"),s.querySelector(p)),c=s.querySelector(w),y=[a?.textContent?.trim()||"",e?.textContent?.trim()||""].join(" ").trim();if(!y)continue;const f=(i?.textContent||"").match(/([\d.]+)\s*out\s*of\s*5/),v=f?parseFloat(f[1]):null,b=(r?.textContent||"").match(/on\s+(.+)$/),S=b?b[1].trim():null,_=(c?.textContent||"").match(/(\d+)\s+people?\s+found/),T=_?parseInt(_[1]):0,R=new n({displayName:o?.textContent?.trim()||null,verifiedPurchase:!!l,helpfulVotes:T,reviewDate:S,ratings:null!==v?[v]:[]});t.push({text:y,title:a?.textContent?.trim()||"",rating:v,date:S,helpfulCount:T,verifiedPurchase:!!l,profile:R,element:s})}catch(e){console.warn("[DID] Failed to extract review:",e)}return t}_extractProductMeta(){const e=document.querySelector("#productTitle"),t=document.querySelector('#acrPopover [data-hook="rating-out-of-text"]'),s=document.querySelector("#acrCustomerReviewText"),n=document.querySelector("[data-asin]"),a=document.querySelectorAll("#histogramTable tr"),i={};for(const e of a){const t=e.querySelector(".a-text-right a")?.textContent,s=e.querySelector(".a-text-right + td .a-size-base")?.textContent;if(t&&s){const e=parseInt(t),n=parseInt(s);isNaN(e)||isNaN(n)||(i[e]=n)}}return{title:e?.textContent?.trim()||"Unknown Product",overallRating:t?.textContent?.trim()||null,totalReviews:s?.textContent?.trim()||null,asin:n?.getAttribute("data-asin")||this._extractASIN(),histogram:i,url:window.location.href}}_extractASIN(){const e=window.location.pathname.match(/\/(?:dp|product)\/([A-Z0-9]{10})/);return e?e[1]:null}_analyzeRatingDistribution(e){const t=e.histogram;if(!t||Object.keys(t).length<3)return null;const s=t[5]||0,n=t[1]||0,a=(t[2]||0)+(t[3]||0)+(t[4]||0);return s>90&&a<5?{score:.2,detail:`${s}% five-star reviews with almost no middle ratings — unusual distribution`}:s>80&&n<2?{score:.4,detail:"Unusually concentrated positive ratings"}:s>50&&n>25&&a<15?{score:.35,detail:"Polarized ratings with few middle reviews — possible fake positive campaign"}:{score:.8,detail:null}}_aggregateSignals(e){const t={},s={};for(const n of e)for(const[e,a]of Object.entries(n)){if(null==a)continue;const n="object"==typeof a?a.score:a;null!=n&&(t[e]||(t[e]=0,s[e]=0),t[e]+=n,s[e]++)}const n={};for(const e of Object.keys(t))n[e]={score:t[e]/s[e],detail:null};return n}_observeForReviews(){const e=new MutationObserver(t=>{(document.querySelector(l)||document.querySelectorAll(c).length>0)&&(e.disconnect(),this.run(),this._observeForNewReviews())});e.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>e.disconnect(),15e3)}_observeForNewReviews(){this._analyzedReviews=this._analyzedReviews||new Set,document.querySelectorAll(c).forEach(e=>{this._analyzedReviews.add(e)});let e=null;const t=new MutationObserver(t=>{const s=document.querySelectorAll(c);let n=!1;for(const e of s)if(!this._analyzedReviews.has(e)){n=!0;break}n&&(clearTimeout(e),e=setTimeout(()=>{this._analyzeNewReviews()},500))}),s=document.querySelector(l),n=s?.parentNode||document.body;t.observe(n,{childList:!0,subtree:!0}),document.addEventListener("click",e=>{const t=e.target;(t.closest('[data-hook="see-all-reviews-link-foot"]')||t.closest(".a-pagination")||t.closest('[data-action="reviews:page-action"]')||t.textContent?.includes("See more reviews")||t.textContent?.includes("Next page"))&&setTimeout(()=>this._analyzeNewReviews(),1500)})}_analyzeNewReviews(){if(this.isRunning)return;const e=document.querySelectorAll(c),t=[];for(const s of e)this._analyzedReviews.has(s)||(t.push(s),this._analyzedReviews.add(s));if(0!==t.length){this.isRunning=!0;try{const e=[];for(const s of t){const t=this._extractSingleReview(s);t&&e.push(t)}if(0===e.length)return void(this.isRunning=!1);this._extractProductMeta();for(const t of e){const e={text:this.textAnalyzer.analyze(t.text),account:this.accountAnalyzer.analyze(t.profile),behavioral:{}},s=this.trustScorer.computeScore(e);this.renderer.renderReviewBadge(s,t.element)}}catch(e){console.error("[DID] New review analysis error:",e)}finally{this.isRunning=!1}}}_extractSingleReview(e){try{const t=e.querySelector(u),s=e.querySelector(h),a=e.querySelector(d),i=e.querySelector(g),r=e.querySelector(m),o=e.querySelector(p),l=e.querySelector(w),c=[s?.textContent?.trim()||"",t?.textContent?.trim()||""].join(" ").trim();if(!c)return null;const y=(a?.textContent||"").match(/([\d.]+)\s*out\s*of\s*5/),f=y?parseFloat(y[1]):null,v=(i?.textContent||"").match(/on\s+(.+)$/),b=v?v[1].trim():null,S=(l?.textContent||"").match(/(\d+)\s+people?\s+found/),_=S?parseInt(S[1]):0;return{text:c,rating:f,date:b,profile:new n({displayName:r?.textContent?.trim()||null,verifiedPurchase:!!o,helpfulVotes:_,reviewDate:b,ratings:null!==f?[f]:[]}),element:e}}catch(e){return console.warn("[DID] Failed to extract review:",e),null}}},v=f.run.bind(f);f.run=async function(){await v()},f.init()})();