(()=>{"use strict";class e{constructor(){this.CACHE_TTL=864e5,this.CACHE_MAX_AGE=6048e5,this.DAILY_FREE_LIMIT=50}async cacheResult(e,t){const a=`cache_${e}`;await chrome.storage.local.set({[a]:{...t,cachedAt:Date.now()}})}async getCachedResult(e){const t=`cache_${e}`,a=(await chrome.storage.local.get(t))[t];return a?Date.now()-a.cachedAt>this.CACHE_TTL?(await chrome.storage.local.remove(t),null):a:null}async getSettings(){return{enabled:!0,platforms:{amazon:!0,reddit:!0,googlemaps:!0,universal:!1},sensitivity:"balanced",showBadges:!0,showTooltips:!0,deepScanEnabled:!1,apiKey:null,tier:"free",...(await chrome.storage.local.get("settings")).settings||{}}}async updateSettings(e){const t={...await this.getSettings(),...e};return await chrome.storage.local.set({settings:t}),t}async getUsageToday(){const e=(new Date).toISOString().split("T")[0],t=(await chrome.storage.local.get("usage")).usage||{};return t.date!==e?{date:e,scans:0,deepScans:0}:t}async incrementUsage(e="scans"){const t=await this.getUsageToday();return t[e]=(t[e]||0)+1,await chrome.storage.local.set({usage:t}),t}async canScan(){return"free"!==(await this.getSettings()).tier||(await this.getUsageToday()).scans<this.DAILY_FREE_LIMIT}async recordScan(e){const t=(await chrome.storage.local.get("stats")).stats||{totalScans:0,flaggedContent:0,platformBreakdown:{},firstScan:Date.now()};t.totalScans++,"LOW_TRUST"!==e.level&&"VERY_LOW_TRUST"!==e.level||t.flaggedContent++;const a=e.platform||"unknown";return t.platformBreakdown[a]=(t.platformBreakdown[a]||0)+1,t.lastScan=Date.now(),await chrome.storage.local.set({stats:t}),t}async getStats(){return(await chrome.storage.local.get("stats")).stats||{totalScans:0,flaggedContent:0,platformBreakdown:{}}}async cleanupOldCache(){const e=await chrome.storage.local.get(null),t=[];for(const[a,s]of Object.entries(e))a.startsWith("cache_")&&s.cachedAt&&Date.now()-s.cachedAt>this.CACHE_MAX_AGE&&t.push(a);return t.length>0&&await chrome.storage.local.remove(t),t.length}}(new class{constructor(){this.storage=new e}async init(){const e=await chrome.runtime.sendMessage({type:"GET_SETTINGS"});if(!e.platforms?.universal)return;const t=window.location.href;if(this._isKnownPlatform(t))return;const a=this.scan();a&&chrome.runtime.sendMessage({type:"PAGE_SCORED",data:{url:t,score:a,platform:"web"}})}scan(){const e=[],t=this._checkMetadata();null!==t&&e.push(t);const a=this._checkPatterns();if(null!==a&&e.push(a),0===e.length)return null;const s=e.reduce((e,t)=>e+t,0)/e.length;return{score:s,level:s>.7?"HIGH_TRUST":s>.5?"MODERATE_TRUST":s>.3?"LOW_TRUST":"VERY_LOW_TRUST",message:`Basic page scan: ${e.length} signals analyzed`,issues:[],signalCount:e.length,confidence:.3}}_checkMetadata(){let e=.5;e=.3+[!!document.querySelector('meta[name="description"]'),!!document.querySelector('meta[name="author"]'),!!document.querySelector('meta[property="og:title"]'),!!document.querySelector('link[rel="canonical"]')].filter(Boolean).length/4*.5;const t=document.title.toLowerCase(),a=[/buy .+ online/,/best .+ 20\d\d/,/top \d+ .+ review/,/cheap .+ for sale/,/free .+ download/];for(const s of a)s.test(t)&&(e-=.15);return Math.max(0,Math.min(1,e))}_checkPatterns(){const e=document.querySelectorAll("script[src]").length;return e>30?.3:e>20?.5:document.querySelectorAll('[style*="display:none"], [style*="visibility:hidden"]').length>20?.4:.7}_isKnownPlatform(e){return["amazon.com","amazon.co.uk","amazon.ca","reddit.com","old.reddit.com","google.com/maps","maps.google.com"].some(t=>e.includes(t))}}).init()})();